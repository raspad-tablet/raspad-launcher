#!/usr/bin/env python3
import os, sys

errors = []

avaiable_options = ['-h', '--help', '--no-dep']

usage = '''
Usage:
    sudo python3 install.py [option]

Options:
               --no-dep    Do not download dependencies
    -h         --help      Show this help text and exit
'''
def install():
    options = []
    if len(sys.argv) > 1:
        options = sys.argv[1:]
        for o in options:
            if o not in avaiable_options:
                print("Option {} is not found.".format(o))
                print(usage)
                quit()
    if "-h" in options or "--help" in options:
        print(usage)
        quit()
    print("RasPad Launcher install process starts")

    print("Install Qt runtime")
    do(msg="Download qt5pi",
        cmd='run_command("wget https://github.com/raspad-tablet/qt5pi/releases/download/v1.0/qt5pi.zip")')
    do(msg="Unzip",
        cmd='run_command("unzip qt5pi.zip")')
    do(msg="Copy",
        cmd='run_command("cp -r ./qt5pi /usr/local/qt5pi")')

    print("Install RasPad Launcher")
    do(msg="Copy raspad-faq.desktop",
        cmd='run_command("cp ./applications/raspad-faq.desktop /usr/share/applications/")')
    do(msg="Copy raspad-launcher.desktop",
        cmd='run_command("cp ./applications/raspad-launcher.desktop /usr/share/applications/")')
    do(msg="Copy icon",
        cmd='run_command("cp ./icons/raspad.png /usr/share/icons/")')
    do(msg="Copy raspad-launcher",
        cmd='run_command("cp ./bin/raspad-launcher /usr/local/bin/")')
    do(msg="Copy raspad-launcher-helper",
        cmd='run_command("cp ./bin/raspad-launcher-helper /usr/local/bin/")')
    do(msg="Add excute permission",
        cmd='run_command("chmod +x /usr/local/bin/raspad-launcher /usr/local/bin/raspad-launcher-helper")')
    if not os.path.isdir("/home/pi/.config/lxpanel"):
        do(msg="cp panel settings",
            cmd='run_command("sudo cp /etc/xdg/lxpanel /home/pi/.config/")')
        do(msg="change panel setting owner",
            cmd='run_command("sudo chown -R pi:pi /home/pi/.config/lxpanel")')
    else:
        do(msg="backup panel setting",
            cmd='run_command("cp /home/pi/.config/lxpanel/LXDE-pi/panels/panel /home/pi/.config/lxpanel/LXDE-pi/panels/panel.bak")')
    do(msg="replace menu icon",
        cmd='run_command("cp ./panel /home/pi/.config/lxpanel/LXDE-pi/panels/panel")')
    do(msg="Reflash panel",
        cmd='run_command("lxpanelctl restart")')

    print("Install MatchBox Keyboard")
    do(msg="Install matchbox-keyboard",
        cmd='run_command("sudo apt install matchbox-keyboard -y")')
    do(msg="Copy matchbox-keyboard.desktop",
        cmd='run_command("sudo cp ./applications/matchbox-keyboard.desktop /usr/share/applications/")')
    do(msg="Copy keyboard-helper",
        cmd='run_command("sudo cp ./bin/keyboard-helper /usr/local/bin/")')
    do(msg="add excutable to helper",
        cmd='run_command("sudo chmod +x /usr/local/bin/keyboard-helper")')

    print("Install screen auto rotator")
    do(msg="Clone package",
        cmd='run_command("git clone --depth=1 https://github.com/sunfounder/python-sh3001")')
    os.chdir("python-sh3001")
    do(msg="Install python-sh3001",
        cmd='run_command("python3 install.py")')
    do(msg="Enable auto rotate",
        cmd='run_command("auto-rotator install")')
    os.chdir("..")


    if len(errors) == 0:
        print("Finished")
        do(msg="Reboot",
            cmd='run_command("reboot")')
    else:
        print("\n\nError happened in install process:")
        for error in errors:
            print(error)
        print("Try to fix it yourself, or contact service@sunfounder.com with this message")
        sys.exit(1)

def cleanup():
    pass

class Modules(object):
    ''' 
        To setup /etc/modules
    '''

    def __init__(self, file="/etc/modules"):
        self.file = file
        with open(self.file, 'r') as f:
            self.configs = f.read()
        self.configs = self.configs.split('\n')

    def remove(self, expected):
        for config in self.configs:
            if expected in config:
                self.configs.remove(config)
        return self.write_file()

    def set(self, name):
        have_excepted = False
        for i in range(len(self.configs)):
            config = self.configs[i]
            if name in config:
                have_excepted = True
                tmp = name
                self.configs[i] = tmp
                break

        if not have_excepted:
            tmp = name
            self.configs.append(tmp)
        return self.write_file()

    def write_file(self):
        try:
            config = '\n'.join(self.configs)
            # print(config)
            with open(self.file, 'w') as f:
                f.write(config)
            return 0, config
        except Exception as e:
            return -1, e

class Config(object):
    ''' 
        To setup /boot/config.txt
    '''

    def __init__(self, file="/boot/config.txt"):
        self.file = file
        with open(self.file, 'r') as f:
            self.configs = f.read()
        self.configs = self.configs.split('\n')

    def remove(self, expected):
        for config in self.configs:
            if expected in config:
                self.configs.remove(config)
        return self.write_file()

    def set(self, name, value=None):
        have_excepted = False
        for i in range(len(self.configs)):
            config = self.configs[i]
            if name in config:
                have_excepted = True
                tmp = name
                if value != None:
                    tmp += '=' + value
                self.configs[i] = tmp
                break

        if not have_excepted:
            tmp = name
            if value != None:
                tmp += '=' + value
            self.configs.append(tmp)
        return self.write_file()

    def write_file(self):
        try:
            config = '\n'.join(self.configs)
            # print(config)
            with open(self.file, 'w') as f:
                f.write(config)
            return 0, config
        except Exception as e:
            return -1, e

class Cmdline(object):
    ''' 
        To setup /boot/cmdline.txt
    '''

    def __init__(self, file="/boot/cmdline.txt"):
        self.file = file
        with open(self.file, 'r') as f:
            cmdline = f.read()
        self.cmdline = cmdline.strip()
        self.cmds = self.cmdline.split(' ')

    def remove(self, expected):
        for cmd in self.cmds:
            if expected in cmd:
                self.cmds.remove(cmd)
        return self.write_file()

    def write_file(self):
        try:
            cmdline = ' '.join(self.cmds)
            # print(cmdline)
            with open(self.file, 'w') as f:
                f.write(cmdline)
            return 0, cmdline
        except Exception as e:
            return -1, e


def run_command(cmd=""):
    import subprocess
    p = subprocess.Popen(
        cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    result = p.stdout.read().decode('utf-8')
    status = p.poll()
    # print(result)
    # print(status)
    return status, result


def do(msg="", cmd=""):
    print(" - %s..." % (msg), end='\r')
    print(" - %s... " % (msg), end='')
    status, result = eval(cmd)
    # print(status, result)
    if status == 0 or status == None or result == "":
        print('Done')
        return True
    else:
        print('Error')
        errors.append("%s error:\n  Status:%s\n  Error:%s" %
                      (msg, status, result))
        return False

if __name__ == "__main__":
    try:
        install()
    except KeyboardInterrupt:
        print("Canceled.")
        cleanup()

# if __name__ == "__main__":
#     test()
